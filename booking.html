<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Private Session - What To Do by Nana Sue</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="components.js" defer></script>
  <!-- Preload Calendly -->
  <link rel="preconnect" href="https://assets.calendly.com">
  <link rel="preload" href="https://assets.calendly.com/assets/external/widget.js" as="script">
  <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js" async></script>
</head>

<body class="bg-gray-50">

  <site-header></site-header>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">

    <div class="max-w-3xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-10">
        <h1 class="text-3xl font-bold text-gray-900">Book a Private Session</h1>
        <p class="text-gray-600 mt-2">1:1 Mobility Class (45 mins) â€¢ <span id="dynamic-total-price">$150.00</span></p>
      </div>

      <!-- Progress Bar -->
      <div class="mb-10">
        <div class="flex items-center justify-between relative">
          <div class="absolute left-0 top-1/2 transform -translate-y-1/2 w-full h-1 bg-gray-200 -z-10"></div>
          <div
            class="absolute left-0 top-1/2 transform -translate-y-1/2 h-1 bg-[var(--sage-green)] -z-10 transition-all duration-300"
            id="progress-line" style="width: 0%"></div>

          <!-- Step 1 (Service) -->
          <div class="flex flex-col items-center bg-gray-50 px-2">
            <div
              class="step-circle active w-10 h-10 rounded-full border-2 border-[var(--sage-green)] bg-white flex items-center justify-center font-bold text-[var(--sage-green)] mb-1"
              id="step-0-indicator">1</div>
            <span class="text-xs font-medium text-gray-600">Service</span>
          </div>

          <!-- Step 2 (Details) -->
          <div class="flex flex-col items-center bg-gray-50 px-2">
            <div
              class="step-circle w-10 h-10 rounded-full border-2 border-gray-300 bg-white flex items-center justify-center font-bold text-gray-400 mb-1"
              id="step-1-indicator">2</div>
            <span class="text-xs font-medium text-gray-500">Details</span>
          </div>

          <!-- Step 3 (Waiver) -->
          <div class="flex flex-col items-center bg-gray-50 px-2">
            <div
              class="step-circle w-10 h-10 rounded-full border-2 border-gray-300 bg-white flex items-center justify-center font-bold text-gray-400 mb-1"
              id="step-2-indicator">3</div>
            <span class="text-xs font-medium text-gray-500">Waiver</span>
          </div>

          <!-- Step 4 (Schedule) -->
          <div class="flex flex-col items-center bg-gray-50 px-2">
            <div
              class="step-circle w-10 h-10 rounded-full border-2 border-gray-300 bg-white flex items-center justify-center font-bold text-gray-400 mb-1"
              id="step-3-indicator">4</div>
            <span class="text-xs font-medium text-gray-500">Schedule</span>
          </div>

          <!-- Step 5 (Payment) -->
          <div class="flex flex-col items-center bg-gray-50 px-2">
            <div
              class="step-circle w-10 h-10 rounded-full border-2 border-gray-300 bg-white flex items-center justify-center font-bold text-gray-400 mb-1"
              id="step-4-indicator">5</div>
            <span class="text-xs font-medium text-gray-500">Payment</span>
          </div>

          <!-- Step 6 (Done) -->
          <div class="flex flex-col items-center bg-gray-50 px-2">
            <div
              class="step-circle w-10 h-10 rounded-full border-2 border-gray-300 bg-white flex items-center justify-center font-bold text-gray-400 mb-1"
              id="step-5-indicator">6</div>
            <span class="text-xs font-medium text-gray-500">Done</span>
          </div>
        </div>
      </div>

      <!-- Main Form Container -->
      <div class="bg-white rounded-2xl shadow-sm p-8 md:p-10 border border-gray-100 min-h-[500px] relative">

        <!-- STEP 0: Service Selection -->
        <div id="step-0" class="fade-in">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Select Service Type</h2>
          <form onsubmit="event.preventDefault(); nextStep(1);">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">

              <!-- In-Home Option -->
              <div class="relative">
                <input type="radio" name="serviceType" id="service-in-home" value="in-home" class="peer hidden" checked>
                <label for="service-in-home"
                  class="block cursor-pointer bg-white p-6 rounded-lg border-2 border-gray-200 hover:border-[var(--sage-green)] peer-checked:border-[var(--sage-green)] peer-checked:bg-green-50 transition-all">
                  <div class="flex flex-col items-center text-center">
                    <i class="fas fa-home text-3xl text-[var(--sage-green)] mb-3"></i>
                    <h3 class="font-bold text-gray-800 text-lg">In-Home Visit</h3>
                    <p class="text-sm text-gray-600 mt-2">We come to you! Available in Manhattan & select areas.</p>
                    <p class="text-xs text-gray-500 mt-1 font-medium">From $150.00</p>
                  </div>
                </label>
              </div>

              <!-- Virtual Option -->
              <div class="relative">
                <input type="radio" name="serviceType" id="service-virtual" value="virtual" class="peer hidden">
                <label for="service-virtual"
                  class="block cursor-pointer bg-white p-6 rounded-lg border-2 border-gray-200 hover:border-[var(--sage-green)] peer-checked:border-[var(--sage-green)] peer-checked:bg-green-50 transition-all">
                  <div class="flex flex-col items-center text-center">
                    <i class="fas fa-video text-3xl text-blue-500 mb-3"></i>
                    <h3 class="font-bold text-gray-800 text-lg">Virtual Visit</h3>
                    <p class="text-sm text-gray-600 mt-2">Expert guidance via video call. Available anywhere.</p>
                    <p class="text-xs text-gray-500 mt-1 font-medium">$150.00 (Flat Rate)</p>
                  </div>
                </label>
              </div>
            </div>

            <!-- Address Input Container (Hidden for Virtual) -->
            <div id="location-gate-container" class="mb-8">
              <label class="block text-sm font-medium text-gray-700 mb-1">Enter your Home Address</label>
              <input type="text" id="GateAddress" class="form-input" placeholder="Street, City, Zip" autocomplete="off">
              <!-- Feedback container will be appended here by JS -->
            </div>

            <div class="mt-8 flex justify-end">
              <button type="submit" id="btn-step-0-next" class="btn-primary">
                Next: Details <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </form>
        </div>

        <!-- STEP 1: Details -->
        <div id="step-1" class="hidden fade-in">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Intake Details</h2>
          <form onsubmit="event.preventDefault(); nextStep(2);">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <!-- Parent Info -->
              <div class="col-span-1 md:col-span-2">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 border-b pb-2">Parent
                  Information</h3>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                <input type="text" id="parentName" required class="form-input" placeholder="First & Last Name">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                <input type="email" id="parentEmail" required class="form-input" placeholder="you@example.com">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                <input type="tel" id="parentPhone" required class="form-input" placeholder="(555) 123-4567">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Home Address <span
                    class="text-xs text-gray-400 font-normal">(Locked from Service Selection)</span></label>
                <input type="text" id="parentAddress" required
                  class="form-input bg-gray-100 text-gray-500 cursor-not-allowed" placeholder="Street, City, Zip"
                  autocomplete="off" readonly>
              </div>

              <!-- Baby Info -->
              <div class="col-span-1 md:col-span-2 mt-2">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 border-b pb-2">Baby's
                  Information</h3>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Baby's Name</label>
                <input type="text" id="babyName" required class="form-input" placeholder="Baby's Name">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                <input type="date" id="babyDob" required class="form-input">
              </div>

              <!-- Concerns -->
              <div class="col-span-1 md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Primary Concerns / Goals</label>
                <textarea id="concerns" rows="3" class="form-input"
                  placeholder="What specific milestones are you working on?"></textarea>
              </div>


            </div>

            <div class="mt-8 flex justify-between">
              <button type="button" onclick="prevStep(0)"
                class="btn-secondary border-gray-300 text-gray-500 hover:bg-gray-50">
                Back
              </button>
              <button type="submit" class="btn-primary">
                Next: Waiver <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </form>
        </div>

        <!-- STEP 2: WAIVER -->
        <div id="step-2" class="hidden fade-in">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Waiver & Release of Liability</h2>

          <div id="waiver-content"
            class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6 h-64 overflow-y-auto text-sm text-gray-600 leading-relaxed">
            <div class="flex items-center justify-center h-full">
              <i class="fas fa-circle-notch fa-spin text-gray-400 text-2xl"></i>
              <span class="ml-3 text-gray-500">Loading waiver...</span>
            </div>
          </div>

          <form id="waiver-form" onsubmit="event.preventDefault(); nextStep(3);">
            <div class="flex items-start mb-8">
              <div class="flex items-center h-5">
                <input id="waiver-agree" type="checkbox" required
                  class="focus:ring-[var(--sage-green)] h-4 w-4 text-[var(--sage-green)] border-gray-300 rounded">
              </div>
              <div class="ml-3 text-sm">
                <label for="waiver-agree" class="font-medium text-gray-700">I have read and agree to the Liability
                  Waiver</label>
                <p class="text-gray-500">You must agree to continue.</p>
              </div>
            </div>

            <div class="flex justify-between mt-8">
              <button type="button" onclick="prevStep(1)"
                class="btn-secondary border-gray-300 text-gray-500 hover:bg-gray-50">
                Back
              </button>
              <button type="submit" class="btn-primary">
                Next: Select Time <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </form>
        </div>

        <!-- STEP 3: SCHEDULE -->
        <div id="step-3" class="hidden fade-in">
          <h2 class="text-2xl font-bold text-gray-800 mb-2">Select a Time</h2>
          <p class="text-gray-500 mb-6">Choose a date and time for your in-home visit.</p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">

            <!-- Custom Calendar Grid -->
            <div id="calendar-wrapper" class="border rounded-xl p-6 bg-white shadow-sm">

              <!-- Month Header -->
              <div class="flex justify-between items-center mb-6">
                <button type="button" id="cal-prev"
                  class="p-2 hover:bg-gray-100 rounded-full text-gray-600 transition-colors" disabled>
                  <i class="fas fa-chevron-left"></i>
                </button>
                <h3 id="cal-month-title" class="font-bold text-lg text-gray-800">Loading...</h3>
                <button type="button" id="cal-next"
                  class="p-2 hover:bg-gray-100 rounded-full text-gray-600 transition-colors">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>

              <!-- Days Header -->
              <div
                class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-bold text-gray-400 uppercase tracking-wide">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
              </div>

              <!-- Days Grid -->
              <div id="cal-grid" class="grid grid-cols-7 gap-1">
                <!-- Dynamic Days -->
              </div>

              <!-- Legend -->
              <div class="mt-4 flex items-center justify-center gap-4 text-xs text-gray-400">
                <div class="flex items-center gap-1">
                  <div class="w-2 h-2 rounded-full border border-[var(--sage-green)]"></div> Available
                </div>
                <div class="flex items-center gap-1">
                  <div class="w-2 h-2 rounded-full bg-[var(--sage-green)]"></div> Selected
                </div>
              </div>
            </div>

            <!-- Time Slots Panel (Shows when date selected) -->
            <div id="time-panel"
              class="hidden border rounded-xl p-6 bg-white shadow-sm h-full max-h-[450px] overflow-y-auto">
              <h4 id="selected-date-header"
                class="font-bold text-lg mb-4 text-gray-800 sticky top-0 bg-white pb-2 border-b">Select Time</h4>
              <div id="slots-container" class="grid grid-cols-1 gap-2">
                <!-- Dynamic Slots -->
              </div>
            </div>

          </div>

          <!-- Hidden Inputs for logic -->
          <input type="hidden" id="selected-start-time">
          <input type="hidden" id="selected-end-time">

          <div class="mt-8 flex justify-between items-center">
            <button type="button" onclick="prevStep(2)" class="text-gray-500 hover:text-gray-700 font-medium">
              <i class="fas fa-arrow-left mr-2"></i> Back
            </button>

            <button type="button" id="btn-next-payment" onclick="nextStep(4)" disabled
              class="btn-primary opacity-50 cursor-not-allowed">
              Next: Payment <i class="fas fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>

        <!-- STEP 4: MOCK PAYMENT -->
        <div id="step-4" class="hidden fade-in">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Secure Payment</h2>

          <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
              <span class="text-lg font-medium text-gray-700">Total Due:</span>
              <span class="text-2xl font-bold text-gray-900" id="payment-display-price">$150.00</span>
            </div>

            <form id="payment-form" onsubmit="event.preventDefault(); processMockPayment();">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Cardholder Name</label>
                <input type="text" class="form-input" placeholder="Name on Card" required>
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Card Number</label>
                <div class="relative">
                  <input type="text" class="form-input pl-10" placeholder="0000 0000 0000 0000" maxlength="19" required>
                  <i class="fas fa-credit-card absolute left-3 top-3 text-gray-400"></i>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                  <input type="text" class="form-input" placeholder="MM/YY" maxlength="5" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">CVC</label>
                  <div class="relative">
                    <input type="text" class="form-input pl-10" placeholder="123" maxlength="3" required>
                    <i class="fas fa-lock absolute left-3 top-3 text-gray-400"></i>
                  </div>
                </div>
              </div>

              <div class="mt-8 flex justify-between items-center">
                <!-- Back button goes to Step 3 (Schedule) -->
                <!-- Actually, usually hitting back from payment to calendar is weird if calendar is just an iframe. 
                        But we can implement basic back logic. -->
                <!-- Wait, Step 3 is Calendly. If we go back, it re-renders. That's fine. -->
                <button type="button" onclick="prevStep(3)" class="text-gray-500 hover:text-gray-700 font-medium">
                  <i class="fas fa-arrow-left mr-2"></i> Back
                </button>

                <button type="submit" id="btn-pay-now" class="btn-primary w-2/3">
                  Pay Now <i class="fas fa-lock ml-2"></i>
                </button>
              </div>
            </form>
          </div>

          <p class="text-center text-xs text-gray-400 mt-4">
            <i class="fas fa-shield-alt mr-1"></i> Payments are secure and encrypted.
          </p>
        </div>

        <!-- STEP 5: CONFIRMATION -->
        <div id="step-5" class="hidden fade-in text-center py-10">
          <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-check text-3xl text-green-600"></i>
          </div>
          <h2 class="text-3xl font-bold text-gray-900 mb-4">Booking Confirmed!</h2>
          <p class="text-xl text-gray-600 mb-8 max-w-md mx-auto">
            Thank you! Your appointment has been scheduled.
          </p>

          <div class="bg-gray-50 rounded-xl p-6 mb-8 text-left max-w-md mx-auto border border-gray-200">
            <p class="mb-2"><strong class="text-gray-800">Confirmation Sent To:</strong> <span id="confirm-email"
                class="text-gray-600">...</span></p>
            <p class="text-[var(--sage-green)] font-medium mt-4"><i class="fas fa-wallet mr-2"></i>Payment of $150.00
              is due in person.</p>
          </div>

          <a href="index.html" class="btn-secondary">Back to Home</a>
        </div>

      </div>
    </div>
  </main>

  <footer class="bg-gray-800 text-gray-400 mt-20 py-10">
    <div class="container mx-auto px-6 text-center">
      <p class="text-sm">&copy; 2025 What To Do by Nana Sue. All rights reserved.</p>
    </div>
  </footer>

  <script>
    // Production-ready API URL Detection
    // Using relative path to rely on Nginx reverse proxy /api -> :3001
    // const API_BASE = ... (removed to fix mixed content/CORS issues)

    // Store data as we go
    // --- API CONFIGURATION ---
    // Determine the Backend URL based on the current environment
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    // If local, assume Backend is on port 3001. If production, use relative path (or specific URL if CORS)
    const API_BASE = isLocal ? 'http://localhost:3001' : '';

    // --- Booking Data State ---
    const bookingData = {
      id: "temp_" + Date.now(), // Temporary ID until saved
      serviceType: 'in-home', // Default
      step0Valid: false,
      price: 150.00,
      waiverAgreed: false,
      // ... other fields populated later
      bookingComplete: false, // flag
      parentName: '',
      parentEmail: '',
      parentPhone: '',
      parentAddress: '',
      babyName: '',
      babyDob: '',
      concerns: '',
      preferredSlots: [],
      waiverVersion: '',
      appointmentTime: 'As Scheduled',
    };

    // Load Waiver on Startup
    document.addEventListener('DOMContentLoaded', () => {
      fetchWaiver();

      // Prevent future dates for baby DOB
      const dobInput = document.getElementById('babyDob');
      if (dobInput) {
        const today = new Date().toISOString().split('T')[0];
        dobInput.setAttribute('max', today);
      }

      // --- NEW: Visit Date Input Logic ---
      const visitDateInput = document.getElementById('visit-date');
      if (visitDateInput) {
        // Enforce 4-digit year
        visitDateInput.addEventListener('input', (e) => {
          const val = e.target.value;
          const parts = val.split('-');
          if (parts[0] && parts[0].length > 4) {
            const newYear = parts[0].slice(0, 4);
            // Reconstruct date string
            e.target.value = `${newYear}${val.substring(parts[0].length)}`;
          }
        });
        // Trigger fetch on change
        visitDateInput.addEventListener('change', fetchTimeSlots);
      }
    });

    async function fetchWaiver() {
      const waiverContainer = document.getElementById('waiver-content');
      const waiverCheckbox = document.getElementById('waiver-agree');
      // The button inside the waiver-form (Step 2)
      const nextBtn = document.querySelector('#waiver-form button[type="submit"]');

      // 1. Lock controls initially
      if (waiverCheckbox) waiverCheckbox.disabled = true;
      if (nextBtn) {
        nextBtn.disabled = true;
        nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }

      try {
        const response = await fetch(`${API_BASE}/api/waiver/latest`);
        if (response.ok) {
          const data = await response.json();
          waiverContainer.innerHTML = data.text;
          bookingData.waiverVersion = data.version;
          console.log("Loaded waiver version:", data.version);

          // 2. Unlock checkbox, but keep button disabled until checked
          if (waiverCheckbox) {
            waiverCheckbox.disabled = false;
            waiverCheckbox.addEventListener('change', function () {
              if (nextBtn) {
                if (this.checked) {
                  nextBtn.disabled = false;
                  nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                  nextBtn.disabled = true;
                  nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
              }
            });
          }

          // Initial state for button: disabled
          if (nextBtn) {
            nextBtn.disabled = true;
            nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
          }
        } else {
          console.error("Server Error:", response.status, response.statusText);
          throw new Error(`Server returned error: ${response.status}`);
        }
      } catch (error) {
        console.error("Waiver fetch error:", error);
        waiverContainer.innerHTML = `
          <div class="flex flex-col items-center justify-center h-full text-red-500 text-center p-4">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p class="font-bold">Unable to load waiver</p>
            <p class="text-xs text-gray-400 mt-2">Error: ${error.message}</p>
          </div>
        `;
        // Ensure they stay locked
        if (waiverCheckbox) {
          waiverCheckbox.disabled = true;
          waiverCheckbox.checked = false;
        }
        if (nextBtn) nextBtn.disabled = true;
      }
    }

    // Navigation Logic
    let isSubmitting = false;

    async function nextStep(step) {
      if (isSubmitting) return;

      // --- Transition: Step 0 (Service) -> Step 1 (Details) ---
      if (step === 1) {
        if (!step0Valid) {
          alert("Please select a valid service option or address.");
          return;
        }
        persistStep0Data();
        loadStep1Data();
        validateStep1(); // Re-check Step 1 state
      }

      // --- Transition: Step 1 (Details) -> Step 2 (Waiver) ---
      if (step === 2) {
        if (!validateStep1()) {
          alert("Please fill in all required fields.");
          return;
        }
        bookingData.parentName = document.getElementById('parentName').value;
        bookingData.parentEmail = document.getElementById('parentEmail').value;
        bookingData.parentPhone = document.getElementById('parentPhone').value;
        bookingData.parentAddress = document.getElementById('parentAddress').value;
        bookingData.babyName = document.getElementById('babyName').value;
        bookingData.babyDob = document.getElementById('babyDob').value;
        bookingData.concerns = document.getElementById('concerns').value;
      }

      // Re-Init Calendar (fetch fresh slots)
      if (!window.calendarInitialized) {
        initCalendar();
        window.calendarInitialized = true;
      }
    }

    // --- Transition: Step 3 (Schedule) -> Step 4 (Payment) ---
    if (step === 4) {
      if (!bookingData.startTime || !bookingData.endTime) {
        alert("Please select a time slot.");
        return;
      }

      // Update Payment Display Price
      const payDisplay = document.getElementById('payment-display-price');
      if (payDisplay && bookingData.price) {
        payDisplay.textContent = `$${bookingData.price.toFixed(2)}`;
      }
    }

    if (step === 5) {
      // Populate confirmation details
      const emailSpan = document.getElementById('confirm-email');
      if (emailSpan) {
        emailSpan.textContent = bookingData.parentEmail || "your email";
      }
    }

    // Hide all steps
    document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.add('hidden'));

    // Show target step
    document.getElementById(`step-${step}`).classList.remove('hidden');

    // Update Indicators
    updateProgress(step);

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- CUSTOM CALENDAR LOGIC ---

    let calendarData = {}; // { "2025-01-01": { status: 'available', slots: [] } }
    let currentMonthDate = new Date(); // Tracks currently viewed month
    let selectedDateStr = null;

    async function initCalendar() {
      const grid = document.getElementById('cal-grid');
      grid.innerHTML = '<div class="col-span-7 py-8 text-center text-gray-400"><i class="fas fa-circle-notch fa-spin"></i> Loading availability...</div>';

      try {
        const res = await fetch(`${API_BASE}/api/booking/slots`);
        if (!res.ok) throw new Error("Failed to load slots");
        calendarData = await res.json();

        // Auto-Jump to first available month
        const firstAvailableCb = Object.entries(calendarData).find(([k, v]) => v.status === 'available');
        if (firstAvailableCb) {
          // Parse YYYY-MM-DD
          const parts = firstAvailableCb[0].split('-'); // [2025, 01, 15]
          currentMonthDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1);
        } else {
          currentMonthDate = new Date(); // Default today
        }

        setupCalendarNav();
        renderMonth();

      } catch (err) {
        console.error("Calendar Init Error:", err);
        grid.innerHTML = '<div class="col-span-7 py-8 text-center text-red-400 text-sm">Error loading calendar.<br>Please refresh page.</div>';
      }
    }

    function setupCalendarNav() {
      document.getElementById('cal-prev').onclick = () => changeMonth(-1);
      document.getElementById('cal-next').onclick = () => changeMonth(1);
    }

    function changeMonth(offset) {
      currentMonthDate.setMonth(currentMonthDate.getMonth() + offset);
      renderMonth();
    }

    function renderMonth() {
      const year = currentMonthDate.getFullYear();
      const month = currentMonthDate.getMonth();

      // Update Title
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      document.getElementById('cal-month-title').textContent = `${monthNames[month]} ${year}`;

      const grid = document.getElementById('cal-grid');
      grid.innerHTML = '';

      // Calculate Days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      const daysInMonth = lastDay.getDate();
      const startDayOfWeek = firstDay.getDay(); // 0 (Sun) - 6 (Sat)

      // Padding (Empty slots before 1st)
      for (let i = 0; i < startDayOfWeek; i++) {
        const empty = document.createElement('div');
        grid.appendChild(empty);
      }

      // Days
      for (let day = 1; day <= daysInMonth; day++) {
        // Construct YYYY-MM-DD key using padded local values
        const dStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = day;
        btn.className = "h-10 w-10 mx-auto flex items-center justify-center rounded-full text-sm font-medium transition-all duration-200";

        const dayData = calendarData[dStr];

        // Check if past
        // Simple check: Is dStr < TodayStr?
        // Or rely on dayData status. API returns unavailable if not in 60 day range usually?
        // Let's assume dayData handles logic.

        if (!dayData || dayData.status === 'unavailable' || dayData.status === 'full') {
          // Disabled
          btn.classList.add('text-gray-300', 'cursor-not-allowed');
          btn.disabled = true;
        } else {
          // Available
          btn.classList.add('text-[var(--sage-green)]', 'bg-emerald-50', 'hover:bg-[var(--sage-green)]', 'hover:text-white', 'border', 'border-[var(--sage-green)]/30');
          if (selectedDateStr === dStr) {
            btn.classList.add('bg-[var(--sage-green)]', 'text-white', 'ring-2', 'ring-offset-1', 'ring-[var(--sage-green)]');
            btn.classList.remove('bg-emerald-50', 'text-[var(--sage-green)]');
          }
          btn.onclick = () => selectDate(dStr);
        }

        grid.appendChild(btn);
      }
    }

    function selectDate(dateStr) {
      selectedDateStr = dateStr;
      renderMonth(); // Re-render to update selection style
      renderSlots(dateStr);
    }

    function renderSlots(dateStr) {
      const panel = document.getElementById('time-panel');
      const container = document.getElementById('slots-container');
      const header = document.getElementById('selected-date-header');

      panel.classList.remove('hidden');

      // Format Header Date
      const dateObj = new Date(dateStr + "T12:00:00"); // Safe parse for header
      const options = { weekday: 'long', month: 'long', day: 'numeric' };
      header.textContent = dateObj.toLocaleDateString('en-US', options);

      container.innerHTML = '';

      const slotList = calendarData[dateStr].slots || [];

      if (slotList.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-400 my-4">No slots available</p>';
        return;
      }

      slotList.forEach(timeStr => {
        // timeStr is "09:00"
        const btn = document.createElement('button');
        btn.type = 'button';

        // Convert to AM/PM for display
        const [h, m] = timeStr.split(':');
        const hour = parseInt(h);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const dispLat = hour > 12 ? hour - 12 : hour; // 13:00 -> 1:00
        const dispH = dispLat === 0 ? 12 : dispLat; // 00:00 -> 12:00? No, range is 9-17
        const label = `${dispH}:${m} ${ampm}`;

        btn.textContent = label;
        btn.className = "w-full py-3 px-4 text-center border rounded-lg text-gray-600 hover:border-[var(--sage-green)] hover:text-[var(--sage-green)] transition-all font-medium";

        // Logic to Select
        btn.onclick = () => selectTimeSlotNew(btn, dateStr, timeStr);
        container.appendChild(btn);
      });
    }

    function selectTimeSlotNew(btn, dateStr, timeStr) {
      // Visuals
      const container = document.getElementById('slots-container');
      Array.from(container.children).forEach(c => {
        c.classList.remove('border-[var(--sage-green)]', 'bg-[var(--sage-green)]', 'text-white');
        c.classList.add('text-gray-600', 'border-gray-200');
      });

      btn.classList.remove('text-gray-600', 'border-gray-200', 'hover:text-[var(--sage-green)]');
      btn.classList.add('bg-[var(--sage-green)]', 'text-white', 'border-[var(--sage-green)]');

      // Data Update
      // Need to construct ISO strings for Backend
      // dateStr "2025-01-01", timeStr "09:30"
      const startIso = `${dateStr}T${timeStr}:00`;
      // End is +45 mins
      // Easy calc:
      const d = new Date(startIso); // Parsing local string -> Local Date
      // Construct standard ISO? No, backend expects what we send.
      // Backend `insertCalendarEvent` takes the string directly for `dateTime`.
      // GCal requires correct Offset if ISO.
      // Chrome `new Date("2025-01-01T09:30:00")` uses Viewer's Browser Timezone.
      // If Viewer is in California (PST), 9:30 is 9:30 PST. 
      // But Nana Sue is in New York (EST).
      // 9:30 PST is 12:30 EST.
      // If we send "2025-01-01T09:30:00" (no Z, no offset) to Backend?
      // Backend `insertCalendarEvent` does: `dateTime: bookingData.startTime`.
      // If string has no offset, GCal assumes... ? 
      // `insertCalendarEvent` HARDCODES `timeZone: 'America/New_York'` in the event resource.
      // Google API says: If `dateTime` has no offset, it uses `timeZone` field.
      // YES! So we SHOULD send "2025-01-01T09:30:00" WITHOUT 'Z' or offset, and let GCal interpret it as NY time.
      // Perfect.

      bookingData.startTime = startIso;

      // Calc End Time string
      // We can't use Date object easily without risking TZ injection.
      // 45 mins math on string:
      let [hh, mm] = timeStr.split(':').map(Number);
      mm += 45;
      if (mm >= 60) {
        hh += 1;
        mm -= 60;
      }
      const endH = hh.toString().padStart(2, '0');
      const endM = mm.toString().padStart(2, '0');
      bookingData.endTime = `${dateStr}T${endH}:${endM}:00`;

      console.log("Selected:", bookingData.startTime, "to", bookingData.endTime);

      // Enable Next
      const nextBtn = document.getElementById('btn-next-payment');
      nextBtn.disabled = false;
      nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    function selectTimeSlot(btn, start, end) {
      // Visual Selection
      const container = document.getElementById('slots-container');
      Array.from(container.children).forEach(c => {
        c.classList.remove('bg-[var(--sage-green)]', 'text-white');
        c.classList.add('text-[var(--sage-green)]');
      });

      btn.classList.remove('text-[var(--sage-green)]');
      btn.classList.add('bg-[var(--sage-green)]', 'text-white');

      // Logic
      document.getElementById('selected-start-time').value = start;
      document.getElementById('selected-end-time').value = end;

      const dt = new Date(start);
      bookingData.startTime = dt.toISOString();
      bookingData.endTime = new Date(end).toISOString();

      // Enable Next
      const nextBtn = document.getElementById('btn-next-payment');
      nextBtn.disabled = false;
      nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    function prevStep(step) {
      document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.add('hidden'));
      document.getElementById(`step-${step}`).classList.remove('hidden');
      updateProgress(step);
    }

    // Updated for 0-5 range (6 steps)
    function updateProgress(step) {
      // Step ranges from 0 to 5
      const progress = (step / 5) * 100;
      document.getElementById('progress-line').style.width = `${progress}%`;

      // Update circles (indicator IDs are 0 to 5)
      for (let i = 0; i <= 5; i++) {
        const circle = document.getElementById(`step-${i}-indicator`);
        if (!circle) continue;

        if (i < step) {
          circle.classList.add('completed');
          circle.innerHTML = '<i class="fas fa-check"></i>';
          circle.classList.remove('active');
        } else if (i === step) {
          circle.classList.add('active');
          circle.innerHTML = i + 1; // Display 1-6 visually
          circle.classList.remove('completed');
        } else {
          circle.classList.remove('active', 'completed');
          circle.innerHTML = i + 1; // Display 1-6 visually
        }
      }
    }

    // --- Mock Payment Processor ---
    async function processMockPayment() {
      const btn = document.getElementById('btn-pay-now');
      const originalText = btn.innerHTML;

      // 1. Loading State
      btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing...';
      btn.disabled = true;
      btn.classList.add('opacity-75', 'cursor-not-allowed');

      // 2. Simulate Network Delay (1.5s)
      await new Promise(resolve => setTimeout(resolve, 1500));

      // 3. Save Data (Complete Booking)
      bookingData.bookingComplete = true; // Now we are actually done
      const saved = await saveBookingData();

      if (saved) {
        // Success! Go to Confirmation (Step 5)
        nextStep(5);
      } else {
        // Error handling
        btn.innerHTML = originalText;
        btn.disabled = false;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
      }
    }

    // --- Step 1 Validation Helper ---
    function validateStep1() {
      const requiredIds = ['parentName', 'parentEmail', 'parentPhone', 'babyName', 'babyDob'];
      let isValid = true;
      requiredIds.forEach(id => {
        const el = document.getElementById(id);
        if (!el || !el.value.trim()) isValid = false;
      });

      const nextBtn1 = document.querySelector('#step-1 button[type="submit"]');
      if (nextBtn1) {
        if (isValid) {
          nextBtn1.classList.remove('opacity-50', 'cursor-not-allowed');
          nextBtn1.disabled = false;
        } else {
          nextBtn1.classList.add('opacity-50', 'cursor-not-allowed');
          nextBtn1.disabled = true;
        }
      }
      return isValid;
    }

    // Attach listener to Step 1 fields
    document.addEventListener('DOMContentLoaded', () => {
      const requiredIds = ['parentName', 'parentEmail', 'parentPhone', 'babyName', 'babyDob'];
      requiredIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', validateStep1);
          el.addEventListener('change', validateStep1);
        }
      });

      // Also define loadFromLocalStorage here to ensure it's available
      if (typeof window.loadStep1Data === 'function') {
        // We call this when entering step 1, but we can also auto-load if we are just refreshing the page and happen to be on step 1?
        // Actually, the user starts at Step 0 usually.
        // But if we want to support refresh persistence for Step 1, we could call it here.
      }
    });

    // --- END LEGACY CALENDLY LISTENER ---



    // Save Data to Backend (Replacing processPayment)
    async function saveBookingData() {
      try {
        const response = await fetch(`${API_BASE}/api/booking`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(bookingData)
        });

        if (response.ok) {
          const data = await response.json();
          if (data.bookingId) {
            bookingData.id = data.bookingId;
          }
          console.log("Booking data saved successfully.");
          return true;
        } else {
          const errorData = await response.json();
          alert(`Issue saving details: ${errorData.message || 'Unknown error'}`);
          return false;
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Network error. Please check your connection.');
        return false;
      }
    }

    // --- END DEBUG CODE ---

  </script>



  <style>
    /* Ensure Google Maps Autocomplete dropdown is visible on top of everything */
    .pac-container {
      z-index: 10000 !important;
    }
  </style>

  <script>
    // --- Google Maps & Service Selection Logic (Step 0) ---
    const CHELSEA_ORIGIN = '10011';

    // Globals for Step 0
    let step0Valid = false;
    let selectedService = 'in-home'; // Default

    // Global error handler
    window.gm_authFailure = function () {
      console.error("Google Maps API Authentication Failure!");
      alert("Google Maps API error: Invalid Key or Billing Issue.");
    };

    window.initMap = function () {
      const addressInput = document.getElementById('GateAddress');
      const nextBtn0 = document.getElementById('btn-step-0-next');
      const locContainer = document.getElementById('location-gate-container');
      const feedbackDiv = document.createElement('div');

      const radioInHome = document.getElementById('service-in-home');
      const radioVirtual = document.getElementById('service-virtual');
      const priceDisplay = document.getElementById('dynamic-total-price');

      feedbackDiv.className = 'mt-2 text-sm font-medium p-3 rounded hidden';
      addressInput.parentNode.appendChild(feedbackDiv);

      // ---- Service Choice Logic ----
      function updateServiceState() {
        if (radioInHome.checked) {
          selectedService = 'in-home';
          locContainer.classList.remove('hidden');
          // Re-validate address
          validateStep0(addressInput.dataset.valid === 'true');
        } else {
          selectedService = 'virtual';
          locContainer.classList.add('hidden');
          feedbackDiv.classList.add('hidden');
          // Virtual always $150 and always valid
          updatePrice(150.00);
          validateStep0(true);
        }
      }

      radioInHome.addEventListener('change', updateServiceState);
      radioVirtual.addEventListener('change', updateServiceState);

      // ---- Validation & Next Button ----
      function validateStep0(isValid) {
        step0Valid = isValid;
        if (isValid) {
          nextBtn0.classList.remove('opacity-50', 'cursor-not-allowed');
          nextBtn0.disabled = false;
        } else {
          nextBtn0.classList.add('opacity-50', 'cursor-not-allowed');
          nextBtn0.disabled = true;
        }
      }

      function updatePrice(price, description = '') {
        bookingData.price = price;
        bookingData.serviceType = selectedService;

        let text = `$${price.toFixed(2)}`;
        if (description) text += ` <span class="text-xs font-normal text-gray-500">(${description})</span>`;
        priceDisplay.innerHTML = text;
      }

      // Initialize State
      updateServiceState();

      // ---- Google Maps Autocomplete (In-Home Only) ----
      try {
        const autocomplete = new google.maps.places.Autocomplete(addressInput, {
          componentRestrictions: { country: "us" },
          fields: ["geometry", "formatted_address", "address_components"]
        });

        autocomplete.addListener('place_changed', function () {
          const place = autocomplete.getPlace();
          if (!place.geometry) {
            addressInput.dataset.valid = 'false';
            showFeedback('Please select a valid address from the list.', 'error');
            validateStep0(false);
            return;
          }

          // Check Manhattan
          let isManhattan = false;
          if (place.address_components) {
            for (const component of place.address_components) {
              if (component.long_name === 'New York County' ||
                (component.short_name === 'New York' && component.types.includes('locality'))) {
                isManhattan = true;
              }
              if (component.long_name === 'Manhattan') isManhattan = true;
            }
          }

          calculateDistance(place.formatted_address, isManhattan);
        });

      } catch (e) {
        console.error("Autocomplete Init Error:", e);
      }

      function calculateDistance(destination, isManhattan) {
        const service = new google.maps.DistanceMatrixService();
        showFeedback('Calculating distance...', 'info');
        validateStep0(false); // Helper disable

        service.getDistanceMatrix({
          origins: [CHELSEA_ORIGIN],
          destinations: [destination],
          travelMode: google.maps.TravelMode.WALKING,
          unitSystem: google.maps.UnitSystem.IMPERIAL
        }, (response, status) => {
          if (status !== 'OK' || response.rows[0].elements[0].status !== 'OK') {
            showFeedback('Unable to calculate route. Please try another address.', 'error');
            return;
          }

          const minutes = response.rows[0].elements[0].duration.value / 60;

          // Zone Logic
          if (minutes <= 30) {
            // Zone 1
            updatePrice(150.00);
            showFeedback('Great! You are in our primary service area.', 'success');
            addressInput.dataset.valid = 'true';
            validateStep0(true);
          } else if (isManhattan) {
            // Zone 2
            updatePrice(180.00, 'Includes $30 Travel Fee');
            showFeedback('You are outside our primary service area. A $30 travel fee applies.', 'warning');
            addressInput.dataset.valid = 'true';
            validateStep0(true);
          } else {
            // Zone 3
            showFeedback(`We're sorry, that's a bit too far. <a href="#" onclick="document.getElementById('service-virtual').click()">Switch to Virtual Visit</a>?`, 'error');
            addressInput.dataset.valid = 'false';
            validateStep0(false);
          }
        });
      }

      function showFeedback(msg, type) {
        feedbackDiv.innerHTML = msg;
        feedbackDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800', 'bg-blue-100', 'text-blue-800');
        if (type === 'success') feedbackDiv.classList.add('bg-green-100', 'text-green-800');
        else if (type === 'error') feedbackDiv.classList.add('bg-red-100', 'text-red-800');
        else if (type === 'warning') feedbackDiv.classList.add('bg-yellow-100', 'text-yellow-800');
        else feedbackDiv.classList.add('bg-blue-100', 'text-blue-800');
        feedbackDiv.classList.remove('hidden');
      }

      // Prevent Enter Key submit
      addressInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.preventDefault(); });

      // Invalidate on Type
      addressInput.addEventListener('input', () => {
        addressInput.dataset.valid = 'false';
        feedbackDiv.classList.add('hidden');
        validateStep0(false);
      });

      // --- Persistence Handlers ---
      // Triggered when Next button (Step 0 -> 1) is clicked
      window.persistStep0Data = function () {
        localStorage.setItem('booking_serviceType', selectedService);
        localStorage.setItem('booking_price', bookingData.price);
        // Only save address if In-Home
        if (selectedService === 'in-home') {
          localStorage.setItem('booking_address', addressInput.value);
        } else {
          localStorage.removeItem('booking_address');
        }
      };

      // Helper for Step 1 Init
      window.loadStep1Data = function () {
        const serviceType = localStorage.getItem('booking_serviceType');
        const address = localStorage.getItem('booking_address');
        const price = localStorage.getItem('booking_price');

        if (address) {
          const addrField = document.getElementById('parentAddress');
          if (addrField) addrField.value = address;
          // Trigger validation event for Step 1
          if (addrField) addrField.dispatchEvent(new Event('input'));
        }

        if (price) {
          const priceNum = parseFloat(price);
          let desc = '';
          if (priceNum > 150) desc = 'Includes $30 Travel Fee';
          updatePrice(priceNum, desc);
        }
      };
    };
  </script>

  <!-- Google Maps API: Loaded AFTER initMap is defined -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBk9l_s9sLgM60sH1a_FoTTWYZkYsgAg8Q&libraries=places,geometry&callback=initMap"
    async defer></script>
</body>

</html>